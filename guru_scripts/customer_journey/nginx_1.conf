user tigergraph  ;
worker_processes 4;
pid   /home/tigergraph/.gsql_fcgi/nginx.pid.1;


events {
  worker_connections  10240;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    client_max_body_size 128M;

    access_log /home/tigergraph/tigergraph/logs/nginx/nginx_1.access.log;
    error_log  /home/tigergraph/tigergraph/logs/nginx/nginx_1.error.log;
    fastcgi_temp_path /tmp/nginx-fastcgi_tigergraph;
    fastcgi_buffers 256 8k;

    ###### [BEGIN] customized headers ######
    add_header X-Frame-Options SAMEORIGIN;
    
    ###### [END] customized headers ######


    keepalive_timeout  900s;

    upstream fastcgi_backend {
      server unix:/home/tigergraph/.gsql_fcgi/RESTPP.socket.1;
      keepalive 128;
    }

    # Keep it for backward compatibility
    server {
        listen       9000 ssl;
        server_name  localhost;

        fastcgi_read_timeout 7200s;
        fastcgi_send_timeout 7200s;

        ssl_certificate /home/tigergraph/tigergraph/config/nginx/ssl.cert;  # if SSL is disabled, ssl_certificate should be '#'
        ssl_certificate_key /home/tigergraph/tigergraph/config/nginx/ssl.key;  # if SSL is disabled, ssl_certificate_key should be '#'


        location / {
           fastcgi_pass fastcgi_backend;
           fastcgi_keep_conn on;
           fastcgi_param REQUEST_METHOD  $request_method;
           fastcgi_param CONTENT_TYPE    $content_type;
           fastcgi_param CONTENT_LENGTH  $content_length;
           fastcgi_param REQUEST_URI     $request_uri;
           fastcgi_param GSQL_TIMEOUT    $http_gsql_timeout;
           fastcgi_param RESPONSE_LIMIT  $http_response_limit;
        }

        location /dashboard {
          #Set whether enable compression
          gzip on;
          gzip_types
               application/javascript  # works significantly with javascript files in GST
          ;
          root /home/tigergraph/ecosys/guru_scripts/customer_journey;
          try_files $uri $uri/ = 404;
        }

        # To ensure the performance of RESTPP, this rule shouldn't be enabled
        # unless restpp.authentication is True.
        # And for performance consideration,
        #!!!!!!!   DO NOT USE REGULAR EXPRESSION HERE !!!!!!!
         location = /requesttoken {
              proxy_ssl_verify off;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_pass http://127.0.0.1:8123;
         }
    }

    server {
      listen 14240 ssl;

      ssl_certificate /home/tigergraph/tigergraph/config/nginx/ssl.cert;  # if SSL is disabled, ssl_certificate should be '#'
      ssl_certificate_key /home/tigergraph/tigergraph/config/nginx/ssl.key;  # if SSL is disabled, ssl_certificate_key should be '#'

      location / {
        #Set whether enable compression
        gzip on;
        gzip_types
             application/javascript  # works significantly with javascript files in GST
        ;
        root /home/tigergraph/tigergraph/visualization/server/src/public/prod;
        try_files $uri $uri/ @backend;
      }

      location /admin {
        #Set whether enable compression
        gzip on;
        gzip_types
             application/javascript  # works significantly with javascript files in GST
        ;
        root /home/tigergraph/tigergraph/visualization/server/src/public;
        try_files $uri $uri/ = 404;
      }

      location @backend {
          proxy_set_header X-Real-IP $remote_addr;
          proxy_pass http://localhost:14242;
      }

      location ~ /ts3/(?<ts3_uri>.*) {
          rewrite ^/ts3/(.*) /$ts3_uri break;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_pass http://localhost:19000;
      }

      location ~ /gsqlserver/(?<gsql_uri>.*) {
          # If this is not configured, by default websocket will timeout
          # after 1 min idle.
          proxy_read_timeout 3600s;

          rewrite ^/gsqlserver/(.*) /$gsql_uri break;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_pass http://localhost:8123;
          proxy_http_version 1.1;
      }

      location /admin/websocket {
          # If this is not configured, by default websocket will timeout
          # after 1 min idle.
          proxy_read_timeout 3600000ms;

          proxy_pass http://localhost:14243;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
      }


      location /websocket {
          # If this is not configured, by default websocket will timeout
          # after 1 min idle.
          proxy_read_timeout 3600000ms;

          proxy_pass http://localhost:14241;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
      }


      # This RESTPP endpoint shares the same security configuration
      fastcgi_read_timeout 7200s;
      fastcgi_send_timeout 7200s;

      location ~ /restpp/(.*) {
           fastcgi_pass fastcgi_backend;
           fastcgi_keep_conn on;
           fastcgi_param REQUEST_METHOD  $request_method;
           fastcgi_param CONTENT_TYPE    $content_type;
           fastcgi_param CONTENT_LENGTH  $content_length;
           fastcgi_param REQUEST_URI     $1?$query_string;  # the url pattern matched above
           fastcgi_param GSQL_TIMEOUT    $http_gsql_timeout;
           fastcgi_param RESPONSE_LIMIT  $http_response_limit;
      }

       location ~ /restpp/(?<token_uri>requesttoken.*) {
            rewrite ^/restpp/(.*) /$token_uri break;
            proxy_ssl_verify off;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass http://127.0.0.1:8123;
       }


    }

}